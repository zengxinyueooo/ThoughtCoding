# AI æ¨¡å‹è¯†åˆ«å¹¶è°ƒç”¨ MCP å·¥å…·çš„å®Œæ•´æµç¨‹

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**AI æ˜¯å¦‚ä½•çŸ¥é“ç”¨æˆ·éœ€è¦è°ƒç”¨å·¥å…·çš„ï¼Ÿå®ƒæ˜¯æ€ä¹ˆè¯†åˆ«å¹¶æ‰§è¡Œå·¥å…·è°ƒç”¨çš„ï¼Ÿ**

---

## ğŸ“‹ å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥: "å¸®æˆ‘è¯»å– pom.xml æ–‡ä»¶"
    â†“
ã€æ­¥éª¤1ã€‘ç³»ç»Ÿæç¤ºæ³¨å…¥
    â†“
ã€æ­¥éª¤2ã€‘AI æ¨¡å‹æ¨ç†
    â†“
ã€æ­¥éª¤3ã€‘ç”Ÿæˆå·¥å…·è°ƒç”¨æ ¼å¼
    â†“
ã€æ­¥éª¤4ã€‘æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹
    â†“
ã€æ­¥éª¤5ã€‘è§£æå¹¶æ‰§è¡Œå·¥å…·
    â†“
ã€æ­¥éª¤6ã€‘è¿”å›ç»“æœç»™ç”¨æˆ·
```

---

## ğŸ” è¯¦ç»†æ­¥éª¤è§£æ

### ã€æ­¥éª¤1ã€‘ç³»ç»Ÿæç¤ºæ³¨å…¥ - AI çš„"è¯´æ˜ä¹¦"

**ä½ç½®**: `LangChainService.prepareMessages()`

å½“ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨**æ¯æ¬¡å¯¹è¯å‰**æ³¨å…¥ä¸€ä¸ªç³»ç»Ÿæç¤ºï¼ˆSystem Promptï¼‰ï¼Œè¿™æ˜¯ AI çš„"ä½¿ç”¨è¯´æ˜ä¹¦"ã€‚

#### ä»£ç å®ç°
```java
private List<ChatMessage> prepareMessages(String input, List<ChatMessage> history) {
    List<ChatMessage> messages = new ArrayList<>();
    
    // ğŸ”¥ å…³é”®æ­¥éª¤ï¼šæ·»åŠ ç³»ç»Ÿæç¤º
    String systemPrompt = buildSystemPromptWithTools();
    messages.add(SystemMessage.from(systemPrompt));
    
    // æ·»åŠ å†å²å¯¹è¯
    messages.addAll(convertToLangChainHistory(history));
    
    // æ·»åŠ ç”¨æˆ·å½“å‰è¾“å…¥
    messages.add(UserMessage.from(input));
    
    return messages;
}
```

#### ç³»ç»Ÿæç¤ºå†…å®¹ç¤ºä¾‹
```text
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œæ‹¥æœ‰å¼ºå¤§çš„å·¥å…·æ¥å¸®åŠ©ç”¨æˆ·å®Œæˆå„ç§ä»»åŠ¡ã€‚

## ğŸ“¦ å¯ç”¨å·¥å…·åˆ—è¡¨

**read_file**
- æè¿°: è¯»å–æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å†…å®¹
- ç±»åˆ«: MCP-filesystem
- å‚æ•°: {"path": "æ–‡ä»¶è·¯å¾„"}

**write_file**
- æè¿°: åˆ›å»ºæˆ–è¦†ç›–æ–‡ä»¶å†…å®¹
- ç±»åˆ«: MCP-filesystem
- å‚æ•°: {"path": "æ–‡ä»¶è·¯å¾„", "content": "æ–‡ä»¶å†…å®¹"}

**list_directory**
- æè¿°: åˆ—å‡ºç›®å½•å†…å®¹
- ç±»åˆ«: MCP-filesystem
- å‚æ•°: {"path": "ç›®å½•è·¯å¾„"}

... (å…±10ä¸ªå·¥å…·)

## ğŸ”§ å·¥å…·è°ƒç”¨æ ¼å¼ï¼ˆé‡è¦ï¼ï¼‰

å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹JSONæ ¼å¼ï¼š

```tool
{
  "tool_name": "å·¥å…·åç§°",
  "parameters": {
    "å‚æ•°å": "å‚æ•°å€¼"
  }
}
```

## ğŸ“ å¸¸ç”¨ç¤ºä¾‹

**è¯»å–æ–‡ä»¶ï¼š**
```tool
{
  "tool_name": "read_file",
  "parameters": {
    "path": "pom.xml"
  }
}
```

è¯·æ ¹æ®ç”¨æˆ·çš„è¯·æ±‚ï¼Œæ™ºèƒ½åœ°é€‰æ‹©åˆé€‚çš„å·¥å…·æ¥å®Œæˆä»»åŠ¡ã€‚
```

#### å‘é€ç»™ AI çš„å®Œæ•´æ¶ˆæ¯ç»“æ„
```json
[
  {
    "role": "system",
    "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹ï¼Œæ‹¥æœ‰ä»¥ä¸‹å·¥å…·...(å®Œæ•´çš„å·¥å…·åˆ—è¡¨å’Œä½¿ç”¨è¯´æ˜)"
  },
  {
    "role": "user",
    "content": "å¸®æˆ‘è¯»å– pom.xml æ–‡ä»¶"
  }
]
```

---

### ã€æ­¥éª¤2ã€‘AI æ¨¡å‹æ¨ç† - "ç†è§£"ç”¨æˆ·æ„å›¾

**å‘ç”Ÿä½ç½®**: DeepSeek API æœåŠ¡å™¨

AI æ¨¡å‹ï¼ˆDeepSeekï¼‰æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šè¿›è¡Œä»¥ä¸‹æ¨ç†ï¼š

#### æ¨ç†è¿‡ç¨‹ï¼ˆæ¨¡å‹å†…éƒ¨ï¼‰
```
1. åˆ†æç”¨æˆ·è¾“å…¥: "å¸®æˆ‘è¯»å– pom.xml æ–‡ä»¶"
   
2. è¯†åˆ«å…³é”®è¯:
   - "è¯»å–" â†’ éœ€è¦è®¿é—®æ–‡ä»¶ç³»ç»Ÿ
   - "pom.xml" â†’ å…·ä½“çš„æ–‡ä»¶å
   - "æ–‡ä»¶" â†’ æ“ä½œå¯¹è±¡æ˜¯æ–‡ä»¶
   
3. æŸ¥æ‰¾ç³»ç»Ÿæç¤ºä¸­çš„å·¥å…·åˆ—è¡¨:
   - å‘ç°æœ‰ "read_file" å·¥å…·
   - æè¿°åŒ¹é…: "è¯»å–æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å†…å®¹"
   
4. ç¡®å®šéœ€è¦è°ƒç”¨å·¥å…·:
   - å·¥å…·åç§°: read_file
   - å‚æ•°: path = "pom.xml"
   
5. æ ¹æ®ç³»ç»Ÿæç¤ºä¸­çš„æ ¼å¼è¦æ±‚ç”Ÿæˆå“åº”
```

#### è¿™ä¸æ˜¯é­”æ³•ï¼Œè€Œæ˜¯åŸºäºï¼š

1. **å¤§è¯­è¨€æ¨¡å‹çš„è¯­ä¹‰ç†è§£èƒ½åŠ›**
   - AI ç»è¿‡æµ·é‡è®­ç»ƒæ•°æ®å­¦ä¹ ï¼Œç†è§£"è¯»å–æ–‡ä»¶"è¿™ç±»æŒ‡ä»¤
   
2. **æç¤ºå·¥ç¨‹ï¼ˆPrompt Engineeringï¼‰**
   - ç³»ç»Ÿæç¤ºæ˜ç¡®å‘Šè¯‰ AI æœ‰å“ªäº›å·¥å…·å¯ç”¨
   - æä¾›äº†æ¸…æ™°çš„å·¥å…·è°ƒç”¨æ ¼å¼ç¤ºä¾‹
   
3. **ä¸Šä¸‹æ–‡å­¦ä¹ ï¼ˆIn-Context Learningï¼‰**
   - AI çœ‹åˆ°ç¤ºä¾‹åï¼Œèƒ½å¤Ÿæ¨¡ä»¿æ ¼å¼ç”Ÿæˆç±»ä¼¼çš„è¾“å‡º

---

### ã€æ­¥éª¤3ã€‘ç”Ÿæˆå·¥å…·è°ƒç”¨æ ¼å¼ - AI çš„è¾“å‡º

**å‘ç”Ÿä½ç½®**: DeepSeek API è¿”å›æµå¼å“åº”

AI æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·åï¼Œä¼šç”ŸæˆåŒ…å«å·¥å…·è°ƒç”¨çš„æ–‡æœ¬å“åº”ã€‚

#### AI ç”Ÿæˆçš„å“åº”ï¼ˆé€å­—æµå¼è¿”å›ï¼‰
```markdown
æˆ‘æ¥å¸®æ‚¨è¯»å– pom.xml æ–‡ä»¶ã€‚

```tool
{
  "tool_name": "read_file",
  "parameters": {
    "path": "pom.xml"
  }
}
```
```

#### ä»£ç æ¥æ”¶æµå¼å“åº”
```java
streamingChatModel.generate(messages, new StreamingResponseHandler<AiMessage>() {
    private StringBuilder fullResponse = new StringBuilder();
    
    @Override
    public void onNext(String token) {
        // å®æ—¶æ¥æ”¶æ¯ä¸ª tokenï¼ˆå­—ç¬¦ç‰‡æ®µï¼‰
        streamingOutput.appendContent(token);
        
        // ğŸ”¥ ç´¯ç§¯å®Œæ•´å“åº”ï¼Œç”¨äºåç»­æ£€æµ‹
        fullResponse.append(token);
    }
    
    @Override
    public void onComplete(Response<AiMessage> response) {
        // AI ç”Ÿæˆå®Œæˆå
        String content = fullResponse.toString();
        
        // ğŸ”¥ æ£€æµ‹æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨
        detectAndExecuteToolCalls(content);
    }
});
```

---

### ã€æ­¥éª¤4ã€‘æ­£åˆ™è¡¨è¾¾å¼æ£€æµ‹ - è¯†åˆ«å·¥å…·è°ƒç”¨

**ä½ç½®**: `LangChainService.detectAndExecuteToolCalls()`

å½“ AI å®Œæˆè¾“å‡ºåï¼Œç³»ç»Ÿä½¿ç”¨**æ­£åˆ™è¡¨è¾¾å¼**æ¥æ£€æµ‹å“åº”ä¸­æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨æ ¼å¼ã€‚

#### æ£€æµ‹é€»è¾‘
```java
private void detectAndExecuteToolCalls(String content) {
    try {
        // ğŸ”¥ æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼šåŒ¹é… ```tool { ... } ```
        String toolPattern = "```tool\\s*\\{([^`]+)\\}\\s*```";
        
        // ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ”¯æŒå¤šè¡ŒåŒ¹é…ï¼‰
        java.util.regex.Pattern pattern = 
            java.util.regex.Pattern.compile(toolPattern, java.util.regex.Pattern.DOTALL);
        
        // åœ¨ AI å“åº”ä¸­æŸ¥æ‰¾åŒ¹é…
        java.util.regex.Matcher matcher = pattern.matcher(content);
        
        // æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„å·¥å…·è°ƒç”¨
        while (matcher.find()) {
            // æå– JSON å†…å®¹ï¼ˆä¸åŒ…æ‹¬ ```tool æ ‡è®°ï¼‰
            String toolCallJson = "{" + matcher.group(1) + "}";
            
            // ğŸ”¥ æ‰§è¡Œå·¥å…·è°ƒç”¨
            executeToolFromJson(toolCallJson);
        }
    } catch (Exception e) {
        System.err.println("âš ï¸ å·¥å…·è°ƒç”¨æ£€æµ‹å¤±è´¥: " + e.getMessage());
    }
}
```

#### æ­£åˆ™è¡¨è¾¾å¼è§£é‡Š
```
```tool\\s*\\{([^`]+)\\}\\s*```

åˆ†è§£è¯´æ˜ï¼š
- ```tool      â†’ åŒ¹é…å­—é¢æ–‡æœ¬ "```tool"
- \\s*         â†’ åŒ¹é…0ä¸ªæˆ–å¤šä¸ªç©ºç™½å­—ç¬¦
- \\{          â†’ åŒ¹é…å·¦èŠ±æ‹¬å· {
- ([^`]+)      â†’ æ•è·ç»„ï¼šåŒ¹é…ä»»æ„éåå¼•å·å­—ç¬¦ï¼ˆJSONå†…å®¹ï¼‰
- \\}          â†’ åŒ¹é…å³èŠ±æ‹¬å· }
- \\s*         â†’ åŒ¹é…0ä¸ªæˆ–å¤šä¸ªç©ºç™½å­—ç¬¦
- ```          â†’ åŒ¹é…ç»“æŸæ ‡è®° "```"
```

#### åŒ¹é…ç¤ºä¾‹

**è¾“å…¥æ–‡æœ¬**:
```
æˆ‘æ¥å¸®æ‚¨è¯»å–æ–‡ä»¶ã€‚

```tool
{
  "tool_name": "read_file",
  "parameters": {
    "path": "pom.xml"
  }
}
```
```

**åŒ¹é…ç»“æœ**:
```java
matcher.group(0) = æ•´ä¸ªåŒ¹é…: ```tool { ... } ```
matcher.group(1) = æ•è·ç»„1:
  "tool_name": "read_file",
  "parameters": {
    "path": "pom.xml"
  }
```

---

### ã€æ­¥éª¤5ã€‘è§£æå¹¶æ‰§è¡Œå·¥å…· - çœŸæ­£çš„è°ƒç”¨

**ä½ç½®**: `LangChainService.executeToolFromJson()`

æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨åï¼Œç³»ç»Ÿä¼šè§£æ JSON å¹¶æ‰§è¡Œç›¸åº”çš„å·¥å…·ã€‚

#### 5.1 è§£æ JSON
```java
private void executeToolFromJson(String json) {
    // ğŸ”¥ æ­¥éª¤1: è§£æ JSON
    ObjectMapper mapper = new ObjectMapper();
    Map<String, Object> toolCall = mapper.readValue(json, Map.class);
    
    // æå–å·¥å…·åç§°
    String toolName = (String) toolCall.get("tool_name");
    // toolName = "read_file"
    
    // æå–å‚æ•°
    Map<String, Object> parameters = (Map<String, Object>) toolCall.get("parameters");
    // parameters = {"path": "pom.xml"}
    
    System.out.println("ğŸ”§ æ‰§è¡Œå·¥å…·: " + toolName);
    System.out.println("ğŸ“ å‚æ•°: " + parameters);
```

#### 5.2 æŸ¥æ‰¾å·¥å…·
```java
    // ğŸ”¥ æ­¥éª¤2: ä» ToolRegistry è·å–å·¥å…·å®ä¾‹
    BaseTool tool = toolRegistry.getTool(toolName);
    // tool = MCP Filesystem çš„ read_file å·¥å…·é€‚é…å™¨
    
    if (tool == null) {
        System.err.println("âŒ å·¥å…·æœªæ‰¾åˆ°: " + toolName);
        return;
    }
```

#### 5.3 è½¬æ¢å‚æ•°
```java
    // ğŸ”¥ æ­¥éª¤3: å°†å‚æ•° Map è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²
    String input = convertParametersToInput(parameters);
    // input = "{\"path\":\"pom.xml\"}"
```

#### 5.4 æ‰§è¡Œå·¥å…·
```java
    // ğŸ”¥ æ­¥éª¤4: æ‰§è¡Œå·¥å…·
    ToolResult result = tool.execute(input);
    
    // å·¥å…·æ‰§è¡Œæµç¨‹:
    // BaseTool.execute(input)
    //   â†’ MCPService.parseInputToParameters(input)
    //   â†’ MCPService.callTool(serverName, toolName, parameters)
    //   â†’ MCPClient.callTool(toolName, arguments)
    //   â†’ å‘é€ JSON-RPC è¯·æ±‚åˆ° MCP æœåŠ¡å™¨
    //   â†’ MCP æœåŠ¡å™¨è¯»å–æ–‡ä»¶
    //   â†’ è¿”å›æ–‡ä»¶å†…å®¹
```

#### 5.5 æ˜¾ç¤ºç»“æœ
```java
    // ğŸ”¥ æ­¥éª¤5: æ˜¾ç¤ºæ‰§è¡Œç»“æœ
    if (result.isSuccess()) {
        System.out.println("\nâœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ:");
        System.out.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        System.out.println(result.getOutput());
        // è¾“å‡º: pom.xml çš„å®Œæ•´å†…å®¹
        System.out.println("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");
    } else {
        System.err.println("\nâŒ å·¥å…·æ‰§è¡Œå¤±è´¥: " + result.getError());
    }
}
```

---

### ã€æ­¥éª¤6ã€‘ç»“æœè¿”å›ç»™ç”¨æˆ·

ç”¨æˆ·åœ¨ç»ˆç«¯çœ‹åˆ°å®Œæ•´çš„è¾“å‡ºï¼š

```
thought> å¸®æˆ‘è¯»å– pom.xml æ–‡ä»¶
ğŸš€ Sending request to DeepSeek API...
ğŸ’¡ æç¤º: è¾“å…¥ 'stop' æˆ–æŒ‰ Ctrl+C å¯ä»¥åœæ­¢ç”Ÿæˆ

æˆ‘æ¥å¸®æ‚¨è¯»å– pom.xml æ–‡ä»¶ã€‚

```tool
{
  "tool_name": "read_file",
  "parameters": {
    "path": "pom.xml"
  }
}
```

ğŸ”§ æ‰§è¡Œå·¥å…·: read_file
ğŸ“ å‚æ•°: {path=pom.xml}

âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.thoughtcoding</groupId>
  ...
  (å®Œæ•´çš„ pom.xml å†…å®¹)
  ...
</project>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š Token usage - Input: 1250, Output: 450, Total: 1700
```

---

## ğŸ“ å…³é”®æŠ€æœ¯ç‚¹è§£æ

### 1. **ä¸ºä»€ä¹ˆ AI èƒ½"ç†è§£"éœ€è¦è°ƒç”¨å·¥å…·ï¼Ÿ**

#### ä¸æ˜¯çœŸçš„ç†è§£ï¼Œè€Œæ˜¯åŸºäºï¼š

**A. æ¨¡å¼åŒ¹é…ï¼ˆPattern Matchingï¼‰**
```
è®­ç»ƒæ•°æ®ä¸­å­¦åˆ°çš„æ¨¡å¼ï¼š
"è¯»å–æ–‡ä»¶" + "æ–‡ä»¶å" â†’ åº”è¯¥ä½¿ç”¨æ–‡ä»¶è¯»å–å·¥å…·
"æœç´¢ä»£ç " + "å…³é”®è¯" â†’ åº”è¯¥ä½¿ç”¨æœç´¢å·¥å…·
"æ‰§è¡Œå‘½ä»¤" + "å‘½ä»¤å†…å®¹" â†’ åº”è¯¥ä½¿ç”¨å‘½ä»¤æ‰§è¡Œå·¥å…·
```

**B. æç¤ºå·¥ç¨‹ï¼ˆPrompt Engineeringï¼‰**
```
ç³»ç»Ÿæç¤ºæ˜ç¡®è¯´æ˜ï¼š
1. æœ‰å“ªäº›å·¥å…·å¯ç”¨
2. æ¯ä¸ªå·¥å…·çš„åŠŸèƒ½æè¿°
3. å¦‚ä½•è°ƒç”¨è¿™äº›å·¥å…·ï¼ˆæ ¼å¼ç¤ºä¾‹ï¼‰
4. ä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨å·¥å…·
```

**C. ä¸Šä¸‹æ–‡å­¦ä¹ ï¼ˆIn-Context Learningï¼‰**
```
çœ‹åˆ°ç¤ºä¾‹åï¼ŒAI ä¼šæ¨¡ä»¿ï¼š
ç³»ç»Ÿæç¤ºä¸­çš„ç¤ºä¾‹: {"tool_name": "read_file", "parameters": {"path": "..."}}
AI çš„è¾“å‡º: {"tool_name": "read_file", "parameters": {"path": "pom.xml"}}
```

### 2. **ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ LangChain4j çš„åŸç”Ÿå·¥å…·è°ƒç”¨ APIï¼Ÿ**

**å½“å‰å®ç°çš„æ–¹æ¡ˆ**: åŸºäºæ–‡æœ¬çš„å·¥å…·è°ƒç”¨æ£€æµ‹ï¼ˆæ­£åˆ™è¡¨è¾¾å¼ï¼‰

**ä¼˜åŠ¿**:
- âœ… ç®€å•å¯é ï¼Œå®¹æ˜“è°ƒè¯•
- âœ… ä¸ä¾èµ–ç‰¹å®šç‰ˆæœ¬çš„ LangChain4j API
- âœ… å¯ä»¥å®Œå…¨æ§åˆ¶å·¥å…·è°ƒç”¨æµç¨‹
- âœ… å…¼å®¹æ€§å¥½ï¼Œé€‚ç”¨äºä»»ä½•æ”¯æŒæ–‡æœ¬è¾“å‡ºçš„ AI æ¨¡å‹

**å¦‚æœä½¿ç”¨åŸç”Ÿ APIï¼ˆFunction Callingï¼‰**:
```java
// LangChain4j çš„åŸç”Ÿå·¥å…·è°ƒç”¨ï¼ˆå¯èƒ½çš„å®ç°ï¼‰
streamingChatModel.builder()
    .tools(List.of(
        ToolSpecification.builder()
            .name("read_file")
            .parameters(...)
            .build()
    ))
    .build();

// ä¼˜åŠ¿: AI æ¨¡å‹åŸç”Ÿæ”¯æŒï¼Œè°ƒç”¨æ›´å¯é 
// åŠ£åŠ¿: ä¾èµ–ç‰¹å®š API ç‰ˆæœ¬ï¼Œçµæ´»æ€§è¾ƒå·®
```

### 3. **å¦‚ä½•ç¡®ä¿ AI ç”Ÿæˆæ­£ç¡®çš„å·¥å…·è°ƒç”¨æ ¼å¼ï¼Ÿ**

#### A. æ¸…æ™°çš„ç³»ç»Ÿæç¤º
```java
prompt.append("å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹JSONæ ¼å¼ï¼Œå¿…é¡»åŒ…å« parameters å­—æ®µï¼š\n\n");
prompt.append("```tool\n");
prompt.append("{\n");
prompt.append("  \"tool_name\": \"å·¥å…·åç§°\",\n");
prompt.append("  \"parameters\": {\n");
prompt.append("    \"å‚æ•°å\": \"å‚æ•°å€¼\"\n");
prompt.append("  }\n");
prompt.append("}\n");
prompt.append("```\n\n");
```

#### B. æä¾›å…·ä½“ç¤ºä¾‹
```java
prompt.append("## ğŸ“ å¸¸ç”¨ç¤ºä¾‹\n\n");
prompt.append("**è¯»å–æ–‡ä»¶ï¼š**\n");
prompt.append("```tool\n");
prompt.append("{\n");
prompt.append("  \"tool_name\": \"read_file\",\n");
prompt.append("  \"parameters\": {\n");
prompt.append("    \"path\": \"pom.xml\"\n");
prompt.append("  }\n");
prompt.append("}\n");
prompt.append("```\n\n");
```

#### C. å®¹é”™å¤„ç†
```java
// å¦‚æœ parameters ç¼ºå¤±ï¼Œè‡ªåŠ¨æ·»åŠ ç©ºå¯¹è±¡
if (parameters == null) {
    System.out.println("âš ï¸ å·¥å…·è°ƒç”¨ç¼ºå°‘ parameters å­—æ®µï¼Œä½¿ç”¨ç©ºå‚æ•°");
    parameters = new HashMap<>();
}
```

---

## ğŸ“Š å®Œæ•´çš„æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·è¾“å…¥: "å¸®æˆ‘è¯»å– pom.xml æ–‡ä»¶"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ThoughtCodingContext åˆå§‹åŒ–                                  â”‚
â”‚ - åŠ è½½é…ç½®                                                   â”‚
â”‚ - è¿æ¥ MCP æœåŠ¡å™¨                                            â”‚
â”‚ - æ³¨å†Œå·¥å…·åˆ° ToolRegistry                                    â”‚
â”‚   * read_file                                                â”‚
â”‚   * write_file                                               â”‚
â”‚   * list_directory                                           â”‚
â”‚   * ...                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LangChainService.prepareMessages()                          â”‚
â”‚ æ„å»ºå‘é€ç»™ AI çš„æ¶ˆæ¯:                                        â”‚
â”‚ [                                                            â”‚
â”‚   {                                                          â”‚
â”‚     "role": "system",                                        â”‚
â”‚     "content": "ä½ æœ‰ä»¥ä¸‹å·¥å…·: read_file, write_file..."      â”‚
â”‚   },                                                         â”‚
â”‚   {                                                          â”‚
â”‚     "role": "user",                                          â”‚
â”‚     "content": "å¸®æˆ‘è¯»å– pom.xml æ–‡ä»¶"                       â”‚
â”‚   }                                                          â”‚
â”‚ ]                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeepSeek API (AI æ¨¡å‹æ¨ç†)                                   â”‚
â”‚ 1. ç†è§£ç”¨æˆ·æ„å›¾: éœ€è¦è¯»å–æ–‡ä»¶                                â”‚
â”‚ 2. æŸ¥æ‰¾å¯ç”¨å·¥å…·: å‘ç° read_file                              â”‚
â”‚ 3. ç”Ÿæˆå·¥å…·è°ƒç”¨æ ¼å¼:                                         â”‚
â”‚    ```tool                                                   â”‚
â”‚    {                                                         â”‚
â”‚      "tool_name": "read_file",                               â”‚
â”‚      "parameters": {"path": "pom.xml"}                       â”‚
â”‚    }                                                         â”‚
â”‚    ```                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StreamingResponseHandler.onNext()                           â”‚
â”‚ æµå¼æ¥æ”¶ AI å“åº”ï¼Œé€å­—ç´¯ç§¯:                                  â”‚
â”‚ "æˆ‘" â†’ "æˆ‘æ¥" â†’ "æˆ‘æ¥å¸®" â†’ ... â†’ "```tool" â†’ ...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StreamingResponseHandler.onComplete()                       â”‚
â”‚ AI è¾“å‡ºå®Œæˆï¼Œè§¦å‘å·¥å…·è°ƒç”¨æ£€æµ‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ detectAndExecuteToolCalls()                                  â”‚
â”‚ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼: ```tool\s*\{([^`]+)\}\s*```                 â”‚
â”‚ åŒ¹é…å¹¶æå–: {"tool_name": "read_file", ...}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ executeToolFromJson()                                        â”‚
â”‚ 1. JSON è§£æ: ObjectMapper.readValue()                       â”‚
â”‚ 2. æå–: toolName="read_file", params={"path":"pom.xml"}    â”‚
â”‚ 3. æŸ¥æ‰¾å·¥å…·: toolRegistry.getTool("read_file")              â”‚
â”‚ 4. è½¬æ¢å‚æ•°: "{\"path\":\"pom.xml\"}"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BaseTool.execute()                                           â”‚
â”‚ â†’ MCPService.parseInputToParameters()                       â”‚
â”‚ â†’ MCPService.callTool()                                      â”‚
â”‚ â†’ MCPClient.callTool()                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP JSON-RPC è¯·æ±‚                                            â”‚
â”‚ {                                                            â”‚
â”‚   "jsonrpc": "2.0",                                          â”‚
â”‚   "method": "tools/call",                                    â”‚
â”‚   "params": {                                                â”‚
â”‚     "name": "read_file",                                     â”‚
â”‚     "arguments": {"path": "pom.xml"}                         â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Server (npx @modelcontextprotocol/server-filesystem)    â”‚
â”‚ æ‰§è¡Œæ–‡ä»¶è¯»å–æ“ä½œï¼Œè¿”å›æ–‡ä»¶å†…å®¹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ˜¾ç¤ºç»“æœç»™ç”¨æˆ·                                               â”‚
â”‚ âœ… å·¥å…·æ‰§è¡ŒæˆåŠŸ:                                             â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                   â”‚
â”‚ <?xml version="1.0"?>                                        â”‚
â”‚ <project>...</project>                                       â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ€»ç»“

### AI è¯†åˆ«å·¥å…·è°ƒç”¨çš„æ ¸å¿ƒæœºåˆ¶

1. **ä¸æ˜¯é­”æ³•**ï¼Œè€Œæ˜¯åŸºäºï¼š
   - ğŸ“ ç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿæç¤ºï¼ˆå‘Šè¯‰ AI æœ‰å“ªäº›å·¥å…·ï¼‰
   - ğŸ§  AI çš„è¯­ä¹‰ç†è§£èƒ½åŠ›ï¼ˆç†è§£ç”¨æˆ·æ„å›¾ï¼‰
   - ğŸ“– æä¾›çš„æ ¼å¼ç¤ºä¾‹ï¼ˆæ•™ AI å¦‚ä½•è¾“å‡ºï¼‰

2. **æ£€æµ‹æœºåˆ¶**ï¼š
   - ğŸ” æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…
   - ğŸ“Š JSON è§£æå’ŒéªŒè¯
   - ğŸ”§ åŠ¨æ€å·¥å…·æŸ¥æ‰¾å’Œæ‰§è¡Œ

3. **é€šç”¨æ€§**ï¼š
   - âœ… é€‚ç”¨äºä»»ä½• MCP å·¥å…·
   - âœ… æ”¯æŒä»»æ„å‚æ•°æ ¼å¼
   - âœ… æ— éœ€ç¡¬ç¼–ç 

### å…³é”®ä»£ç ä½ç½®

| æ­¥éª¤ | ä½ç½® | ä½œç”¨ |
|------|------|------|
| ç³»ç»Ÿæç¤º | `LangChainService.buildSystemPromptWithTools()` | å‘Šè¯‰ AI æœ‰å“ªäº›å·¥å…· |
| æ¶ˆæ¯å‡†å¤‡ | `LangChainService.prepareMessages()` | æ³¨å…¥ç³»ç»Ÿæç¤º |
| å“åº”æ¥æ”¶ | `StreamingResponseHandler.onNext()` | ç´¯ç§¯ AI å“åº” |
| å·¥å…·æ£€æµ‹ | `LangChainService.detectAndExecuteToolCalls()` | æ­£åˆ™åŒ¹é…å·¥å…·è°ƒç”¨ |
| å·¥å…·æ‰§è¡Œ | `LangChainService.executeToolFromJson()` | è§£æå¹¶æ‰§è¡Œå·¥å…· |

---

**æ–‡æ¡£æ—¥æœŸ**: 2025-11-06  
**æŠ€æœ¯ç±»å‹**: åŸºäºæç¤ºå·¥ç¨‹çš„å·¥å…·è°ƒç”¨ç³»ç»Ÿ  
**æ ¸å¿ƒæŠ€æœ¯**: ç³»ç»Ÿæç¤º + æ­£åˆ™è¡¨è¾¾å¼ + åŠ¨æ€å·¥å…·æ³¨å†Œ

